---
layout: post
title: "Web 安全基础 —— 文件解析漏洞"
date: 2018-5-26
excerpt: "一些常见的服务器文件解析漏洞"
tag:
- 文件解析漏洞
- Web Seurity Base
comments: true
---


## 0x00 概述

CasperKid 师傅以前在一篇 paper 里写到他对渗透测试本质的看法，大概意思是抽象来看，渗透测试的本质就是

> 代码注入 + 代码解析/代码执行

像 SQL Inject、Remote Code Execution 之类的是让直接让代码、SQL 语句等直接注入一个可以直接执行的环境里，就不用考虑代码执行的部分。

而像文件上传这样的就是做到了代码注入，但还要想办法让代码被解析，从而达到目的。

文件解析漏洞和上次讲到的 [FIle Inclusion](https://aquilao.github.io/Blog/file_inclusion/) 一样，都是攻击者经常用来解析代码的方法。



## 0x01 Apache

### Apache 未知扩展名解析漏洞

Apache 对文件名是从后向前解析的，如果 PHP 以 module 方式工作在 Apache 上的话会跳过未知（未在 mime.type 中收录）的文件名，直到遇到已知的文件名，若是'.php'，'.php5'之类的话则当作 php 文件解析

比如

    a.php.aaa.bbb.ccc

会被当作

    a.php

来解析

具体可以看这篇文章 [Apache解析漏洞详解](https://www.cnblogs.com/milantgh/p/5116955.html)

### .hataccess 文件

.htaccess 文件是 Apache 的一个配置文件，它负责相关目录下的网页配置。

如果在 Apache 中 .htaccess 可被执行且可被上传，那就可以自己定义哪些文件可以被解析了。

比如我们可以在 .htaccess 中写入:

	<FilesMatch ".(jpg)$"> 
	SetHandler application/x-httpd-php 
	</FilesMatch>

所有的扩展名为 jpg 的文件都会被当作 php 被解析

## 0x02 IIS

### IIS 6.0 解析漏洞

1. 目录名里有".asp"、".asa"的目录中的所有文件都会被当作 asp 文件来解析
2. 文件名像是"a.asp;b.jpg"时也会被当中 asp 文件解析

第一点的话很好理解

比如在根目录下名为"a.asp"的目录中有个名为"b.jpg"的 asp 图马

payload

    http://127.0.0.1/a.asp/b.jpg

使用 payload 就能解析了

接下来是第二点

将一个 asp 图马命名为 a.asp;b.jpg 然后上传，只要访问这个文件就能解析了

payload

    http://127.0.0.1/a.asp;b.jpg

### IIS 7.0/7.5

过在 PHP FastCGI，并不是 IIS 的问题，会在后面讲到。



## 0x03 Nginx


### 00 截断

00 截断要求 Nginx <= 0.837 & php < 5.3.4 & magic_quotes_gpc = Off

比如我们上传了一个名为"a.jpg"的 php 图马在网站根目录下

payload

    http://127.0.0.1/a.jpg%00php

使用该 payload 就可以把这个图马作为 php 解析了


### Nginx 文件名逻辑漏洞（CVE-2013-4547）

CVE-2013-4547 会在 version > 0.8.41 & version < 1.4.3 || version <= 1.5.7 的情况下起效

比如我们在网站根目录下有个名为"a.jpg "（注意后面有个空格）的 php 图马，

payload

    http://127.0.0.1/a.jpg \0.php

Linux 下 php-fpm 默认限制的后缀名为 php，所以该漏洞在 linux 下很难实现，除非 php-fpm.conf 中的 security.limit_extensions 为空，不然访问只会提示 "Access Denied"

不过在 Windows 下则很容易实现，Windows 的文件名是不可以有空格的，如果有也会被去掉。在 Windows 下，我们就没必要上传带空格的文件了,只要上传一个普通的图马然后使用像上面一样的 payload 就可成功解析了

### PHP FastCGI 路径解析漏洞

不是 Nginx 自身的漏洞，但在 Nginx 上较为常见，下一节将介绍


## 0x04 PHP FastCGI 路径解析漏洞

php.ini 默认设置 cgi.fix_pathinfo = 1 的情况下使用 fastcgi server 的服务器（Nginx、IIS 7.0/7.5）上一般会出现该漏洞

举个栗子，在网站根目录下有个名为"a.jpg"的 php 图马

payload

    http://127.0.0.1/a.jpg/b.php

服务器找不到"b.php"，于是就向前解析，将"a.jpg"作为 php 文件解析了。
 


## 0x05 防御方法

首先最好的方法就是设置保存上传文件的目录不可执行，只要没有权限，恶意代码也没办法。另外因服务器不同也有某些地方得注意

### Apache

1. 不使用 module 方式
2. 修改 Apache 配置文件，禁止像是".php."这样的文件执行

### IIS 6.0

不给用户创建文件夹的权限

### IIS 7.0/7.5

把 php.ini 中的 cgi.fix_pathinfo 的值改为 0

### Nginx

1. 更新到最新版
2. 把 php.ini 中的 cgi.fix_pathinfo 的值改为 0



## 0x06 参考

1. [CVE-2013-4547 Nginx解析漏洞深入利用及分析](http://www.91ri.org/9064.html)
2. [文件解析漏洞总结-Nginx](https://blog.csdn.net/wn314/article/details/77388289)
3. [在PHP中使用FastCGI解析漏洞及修复方案](http://www.jb51.net/article/74629.htm)
4. [Apache解析漏洞详解](https://www.cnblogs.com/milantgh/p/5116955.html)
5. [IIS WebDAV安全配置](https://www.2cto.com/article/201307/228165.html)
